<!DOCTYPE html>
<html>
<head>
  <title>TagRace Check-In</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <h1>TagRace GPS Check-In</h1>

  <p>
    This tag is on a journey to <strong>Hope, British Columbia</strong>.<br>
    Click the button below to check in your current location.
  </p>

  <div id="location-info">üìç Loading last known location‚Ä¶</div>

  <button onclick="getLocation()">Click to update the tag location!</button>
  <div id="status">Waiting for check-in‚Ä¶</div>

  <script>
    function getLocation() {
      if (!navigator.geolocation) {
        document.getElementById("status").innerText = "Geolocation not supported.";
        return;
      }

      navigator.geolocation.getCurrentPosition(success, error);
    }

    function success(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      const location = `${lat},${lon}`;

      const payload = {
        tagId: "ZA-004",
        location: location,
        battery: "3.8V",
        status: "active",
        timestamp: new Date().toISOString()
      };

      document.getElementById("status").innerText = "Sending check-in‚Ä¶";

      fetch("https://tagrace-webhook.onrender.com/smarttag", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(res => {
        if (res.ok) {
          document.getElementById("status").innerText = "Check-in successful!";
        } else {
          document.getElementById("status").innerText = "Server error.";
        }
      })
      .catch(err => {
        console.error("Fetch error:", err);
        document.getElementById("status").innerText = "Network error.";
      });
    }

    function error(err) {
      document.getElementById("status").innerText = "Location error: " + err.message;
    }

    fetch("https://sheetdb.io/api/v1/fyyvku4q2tqb0")
      .then(res => res.json())
      .then(data => {
        const valid = data.filter(entry => entry.location && entry.location.includes(','));
        const last = valid[valid.length - 1];
        const finalDestination = "Hope, British Columbia (49.3794, -121.4414)";

        if (last) {
          document.getElementById("location-info").innerHTML = `
            Last Check-In: ${last.location}<br>
            Timestamp: ${last.timestamp}<br>
            Final Destination: ${finalDestination}
          `;
        } else {
          document.getElementById("location-info").innerText = "No check-ins yet.";
        }
      })
      .catch(err => {
        console.error("Error loading last location:", err);
        document.getElementById("location-info").innerText = "Error loading last location.";
      });
  </script>
</body>
</html>
