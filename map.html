<!DOCTYPE html>
<html>
<head>
  <title>TagRace Journey Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
    }
    body {
      font-family: sans-serif;
      display: flex;
    }
    #map {
      flex: 1;
      height: 100vh;
      position: relative;
    }
    #sidebar {
      width: 260px;
      background: #111;
      color: white;
      overflow-y: auto;
      padding: 0.8em;
      font-size: 0.85em;
    }
    h2 {
      margin-top: 0;
      font-size: 1em;
      color: #00ff66;
    }
    .checkin {
      margin-bottom: 0.6em;
      border-bottom: 1px solid #333;
      padding-bottom: 0.6em;
      font-size: 0.8em;
      line-height: 1.4;
    }
    .checkin img {
      max-width: 100%;
      max-height: 120px;
      border-radius: 4px;
      margin-top: 0.4em;
      object-fit: cover;
    }
    a {
      color: #00ffcc;
      text-decoration: underline;
    }
    #hippo-thumbnail {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1001;
      background: rgba(0,0,0,0.5);
      padding: 6px;
      border-radius: 8px;
    }
    #hippo-thumbnail img {
      width: 60px;
      height: auto;
      border-radius: 4px;
    }
    #last-checkin-badge {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: #00ffcc;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.85em;
      z-index: 1002;
      pointer-events: none;
    }
    .toggle-group {
      margin-top: 1em;
      background: rgba(0,0,0,0.5);
      padding: 0.5em;
      border-radius: 6px;
    }
    .toggle-group label {
      display: block;
      margin-bottom: 0.5em;
    }
    @media (max-width: 768px) {
      #sidebar {
        position: absolute;
        width: 100%;
        height: 50%;
        bottom: 0;
        left: 0;
        overflow-y: auto;
        background: rgba(0,0,0,0.9);
        z-index: 999;
      }
      #map {
        height: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>🦛 TagRace Journey Summary</h2>
    <div id="summary">Loading...</div>
   <div class="toggle-group">
  <label><input type="checkbox" checked onchange="toggleTag('spongebob', this.checked)"> 🧽 Show Spongebob</label>
  <label><input type="checkbox" checked onchange="toggleTag('patrick', this.checked)"> 🌸 Show Patrick</label>
  <label><input type="checkbox" checked onchange="toggleTag('smileys', this.checked)"> 😀 Show 3 Smileys</label>
  <label><input type="checkbox" checked onchange="toggleTag('hippo', this.checked)"> 🦛 Show Suzie</label>
  <label><input type="checkbox" checked onchange="toggleTag('penguin', this.checked)"> 🐧 Show Percy</label>
</div>
    <h2>📍 Last 10 Check-Ins</h2>
    <div id="checkin-list">Loading...</div>
  </div>
  <div id="map">
    <div id="hippo-thumbnail">
      <img src="https://michaelcr18.github.io/tagrace-checkin/hippo.PNG" alt="Hippo mascot">
    </div>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
  const hippoIcon = L.icon({
    iconUrl: 'https://michaelcr18.github.io/tagrace-checkin/hippo.jpg',
    iconSize: [40, 40],
    iconAnchor: [20, 40],
    popupAnchor: [0, -40]
  });

  const penguinIcon = L.icon({
    iconUrl: 'https://michaelcr18.github.io/tagrace-checkin/penguin.jpg',
    iconSize: [40, 40],
    iconAnchor: [20, 40],
    popupAnchor: [0, -40]
  });

const spongebobIcon = L.icon({
  iconUrl: 'https://michaelcr18.github.io/tagrace-checkin/spongebob.png',
  iconSize: [40, 40],
  iconAnchor: [20, 40],
  popupAnchor: [0, -40]
});

const patrickIcon = L.icon({
  iconUrl: 'https://michaelcr18.github.io/tagrace-checkin/patrick.png',
  iconSize: [40, 40],
  iconAnchor: [20, 40],
  popupAnchor: [0, -40]
});

const smileysIcon = L.icon({
  iconUrl: 'https://michaelcr18.github.io/tagrace-checkin/smileys.png',
  iconSize: [40, 40],
  iconAnchor: [20, 40],
  popupAnchor: [0, -40]
});
  const map = L.map('map').setView([0, 0], 2);
  L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
  maxZoom: 17,
  attribution: 'Map data: © OpenStreetMap contributors, SRTM | Tiles: © OpenTopoMap'
}).addTo(map);

  const hippoColor = '#00ff66';
  const penguinColor = '#3399ff';

const spongebobColor = '#ffff00';
const patrickColor = '#ff33cc';
const smileysColor = '#ffcc00';

const spongebobMarkers = [];
const patrickMarkers = [];
const smileysMarkers = [];

const spongebobPath = [];
const patrickPath = [];
const smileysPath = [];

let spongebobPolyline, patrickPolyline, smileysPolyline;

let spongebobPolyline, patrickPolyline, smileysPolyline;
  const hippoMarkers = [];
  const penguinMarkers = [];
  const hippoPath = [];
  const penguinPath = [];

  let hippoPolyline, penguinPolyline;

  function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const toRad = deg => deg * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  async function getTownAndCountry(lat, lon) {
  const url = `https://api.geoapify.com/v1/geocode/reverse?lat=${lat}&lon=${lon}&apiKey=67cfc38cc2264ec5bd420c63df393331`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    const props = data.features[0]?.properties || {};
    return {
      town: props.city || props.town || props.village || "Unknown",
      countryCode: props.country_code?.toUpperCase() || "UN",
      countryName: props.country || "Unknown" // ✅ Add this line here
    };
  } catch {
    return {
      town: "Unknown",
      countryCode: "UN",
      countryName: "Unknown" // ✅ Add this line here too
    };
  }
}


  function toggleTag(tag, show) {
  const tagMap = {
    hippo: { markers: hippoMarkers, polyline: hippoPolyline },
    penguin: { markers: penguinMarkers, polyline: penguinPolyline },
    spongebob: { markers: spongebobMarkers, polyline: spongebobPolyline },
    patrick: { markers: patrickMarkers, polyline: patrickPolyline },
    smileys: { markers: smileysMarkers, polyline: smileysPolyline }
  };

  const group = tagMap[tag];
  if (!group) return;

  if (show) {
    group.markers.forEach(m => m.addTo(map));
    if (group.polyline) group.polyline.addTo(map);
  } else {
    group.markers.forEach(m => map.removeLayer(m));
    if (group.polyline) map.removeLayer(group.polyline);
  }
}


  fetch("https://sheetdb.io/api/v1/fyyvku4q2tqb0")
    .then(res => res.json())
    .then(async data => {
      const valid = data.filter(entry => entry.location && entry.location.includes(','));
      const spongebobData = valid.filter(e => e.tagId === "ZA-001");
const patrickData = valid.filter(e => e.tagId === "ZA-002");
const smileysData = valid.filter(e => e.tagId === "ZA-003");
const hippoData = valid.filter(e => e.tagId === "ZA-004");
const penguinData = valid.filter(e => e.tagId === "ZA-005");

const recent = [...spongebobData, ...patrickData, ...smileysData, ...hippoData, ...penguinData]
  .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
  .slice(0, 10);

      const firstDate = new Date(valid[0]?.timestamp);
      const today = new Date();
      const totalDays = Math.ceil((today - firstDate) / (1000 * 60 * 60 * 24));

      let totalDistance = 0;
      let previous = null;

      const list = document.getElementById("checkin-list");
      list.innerHTML = "";

      await Promise.all(recent.map(async entry => {
  const [lat, lon] = entry.location.split(',').map(Number);
  const geo = await getTownAndCountry(lat, lon);
  entry.countryName = geo.countryName; // ✅ Add this line

        const distance = previous ? haversine(previous.lat, previous.lon, lat, lon) : 0;
        totalDistance += distance;
        previous = { lat, lon };

        let tagEmoji = "❓";
let icon = null;
let markerArray = null;
let pathArray = null;

if (entry.tagId === "ZA-001") {
  tagEmoji = "🧽";
  icon = spongebobIcon;
  markerArray = spongebobMarkers;
  pathArray = spongebobPath;
} else if (entry.tagId === "ZA-002") {
  tagEmoji = "🌸";
  icon = patrickIcon;
  markerArray = patrickMarkers;
  pathArray = patrickPath;
} else if (entry.tagId === "ZA-003") {
  tagEmoji = "😀";
  icon = smileysIcon;
  markerArray = smileysMarkers;
  pathArray = smileysPath;
} else if (entry.tagId === "ZA-004") {
  tagEmoji = "🦛";
  icon = hippoIcon;
  markerArray = hippoMarkers;
  pathArray = hippoPath;
} else if (entry.tagId === "ZA-005") {
  tagEmoji = "🐧";
  icon = penguinIcon;
  markerArray = penguinMarkers;
  pathArray = penguinPath;
} else {
  return; // skip unknown tags
}

const marker = L.marker([lat, lon], { icon }).bindPopup(`
  <strong>${entry.name || "Anonymous"}</strong><br>
  🕒 ${entry.timestamp}<br>
  ${tagEmoji} ${geo.town}<br>
  ${geo.countryCode ? `<img src="https://flagsapi.com/${geo.countryCode}/flat/32.png">` : ""}
  ${entry.photo && entry.photo.startsWith("http") ? `<br><a href="${entry.photo}" target="_blank">📸 View Photo</a>` : ""}
`);
marker.addTo(map);
markerArray.push(marker);
pathArray.push([lat, lon]);


        list.innerHTML += `
          <div class="checkin">
            <strong>${entry.name || "Anonymous"}</strong><br>
            🕒 ${entry.timestamp}<br>
            ${tagEmoji} ${geo.town}<br>
            ${geo.countryCode ? `<img src="https://flagsapi.com/${geo.countryCode}/flat/32.png">` : ""}
            🛣️ Distance from previous: ${distance.toFixed(1)} km<br>
            ${entry.photo && entry.photo.startsWith("http")
              ? `<a href="${entry.photo}" target="_blank">📸 View Photo</a><br><img src="${entry.photo}" alt="Uploaded photo">`
              : ""}
          </div>
        `;
      }));

      if (hippoPath.length > 1) {
        hippoPolyline = L.polyline(hippoPath, { color: hippoColor, weight: 4 }).addTo(map);
      }

      if (penguinPath.length > 1) {
        penguinPolyline = L.polyline(penguinPath, { color: penguinColor, weight: 4 }).addTo(map);
      }

      if (spongebobPath.length > 1) {
  spongebobPolyline = L.polyline(spongebobPath, { color: spongebobColor, weight: 4 }).addTo(map);
}
if (patrickPath.length > 1) {
  patrickPolyline = L.polyline(patrickPath, { color: patrickColor, weight: 4 }).addTo(map);
}
if (smileysPath.length > 1) {
  smileysPolyline = L.polyline(smileysPath, { color: smileysColor, weight: 4 }).addTo(map);
}

    
      hippoMarkers.forEach(m => m.addTo(map));
      penguinMarkers.forEach(m => m.addTo(map));
      spongebobMarkers.forEach(m => m.addTo(map));
patrickMarkers.forEach(m => m.addTo(map));
smileysMarkers.forEach(m => m.addTo(map));


      document.getElementById("summary").innerHTML = `
        <p>🛣️ <strong>Total Distance:</strong> ${totalDistance.toFixed(1)} km</p>
        <p>📅 <strong>Days Traveled:</strong> ${totalDays} days</p>
      `;

      // Highlight last check-in
      const lastEntry = recent[0];
      if (lastEntry && lastEntry.location) {
        const [lat, lon] = lastEntry.location.split(',').map(Number);
        let lastEmoji = "❓";
let lastIcon = null;

if (lastEntry.tagId === "ZA-001") {
  lastEmoji = "🧽";
  lastIcon = spongebobIcon;
} else if (lastEntry.tagId === "ZA-002") {
  lastEmoji = "🌸";
  lastIcon = patrickIcon;
} else if (lastEntry.tagId === "ZA-003") {
  lastEmoji = "😀";
  lastIcon = smileysIcon;
} else if (lastEntry.tagId === "ZA-004") {
  lastEmoji = "🦛";
  lastIcon = hippoIcon;
} else if (lastEntry.tagId === "ZA-005") {
  lastEmoji = "🐧";
  lastIcon = penguinIcon;
}


        const lastMarker = L.marker([lat, lon], {
          icon: lastIcon
        }).bindPopup(`
          <strong>Last Check-In</strong><br>
          ${lastEmoji} ${lastEntry.name || "Anonymous"}<br>
          🕒 ${lastEntry.timestamp}
        `).addTo(map);

        lastMarker.openPopup();
        map.setView([lat, lon], 6);

        const badge = document.createElement("div");
        badge.id = "last-checkin-badge";
        badge.innerHTML = `📍 Last Check-In: <strong>${lastEmoji} ${lastEntry.name || "Anonymous"}</strong> in <em>${lastEntry.location}</em>`;
        document.body.appendChild(badge);
      }

      // ✅ Darken unvisited countries
      fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
  .then(res => res.json())
  .then(worldData => {
    const visitedCountries = new Set(
      recent.map(e => e.countryName?.toLowerCase()).filter(Boolean)
    );
    console.log("✅ Visited countries:", Array.from(visitedCountries));

    L.geoJSON(worldData, {
      style: feature => {
        const name = feature.properties.name?.toLowerCase();
        console.log("🌍 GeoJSON country name:", name);

        if (visitedCountries.has(name)) {
          console.log("✅ MATCHED:", name);
        } else {
          console.log("❌ NOT MATCHED:", name);
        }

        const visited = name && visitedCountries.has(name);
        return {
          fillColor: visited ? '#222' : '#000',
          fillOpacity: visited ? 0.1 : 0.6,
          color: visited ? '#00ff66' : '#444',
          weight: visited ? 1 : 0.5
        };
      }
    }).addTo(map);
  });


    })
    .catch(err => {
      console.error("❌ Error loading check-ins:", err);
      document.getElementById("checkin-list").innerText = "❌ Failed to load check-ins.";
    });
</script>
  
<div style="position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); font-size: 0.7em; color: #888; z-index: 1003;">
  TagRace Map v1.18 — 2025-09-23
</div>

</body>
</html>
